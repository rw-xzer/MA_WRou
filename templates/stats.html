<!doctype html>
{% extends "base.html" %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'app.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %} {% block content %}
<main class="flex h-[91.7dvh] flex-col overflow-hidden bg-gray-50">
  <!-- Top Controls -->
  <div class="flex items-center justify-between border-b border-gray-300 bg-white px-6 py-4">
    <h1 class="text-2xl font-bold">Study Statistics</h1>
    <div class="flex items-center gap-4">
      <!-- Total Hours Counter -->
      <div class="rounded-lg border border-gray-300 bg-white px-4 py-2">
        <span class="text-sm text-gray-600">Total: </span>
        <span id="totalHours" class="text-lg font-semibold">0h 0m</span>
      </div>

      <!-- Tag Button -->
      <button id="tagButton" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium hover:bg-gray-50">
        Organize Colors
      </button>

      <!-- View Toggle -->
      <div class="flex rounded-lg border border-gray-300 bg-white">
        <button id="monthlyBtn" class="view-toggle px-4 py-2 text-sm font-medium bg-blue-500 text-white" data-view="monthly">Monthly</button>
        <button id="weeklyBtn" class="view-toggle px-4 py-2 text-sm font-medium bg-white text-gray-700" data-view="weekly">Weekly</button>
      </div>
    </div>
  </div>

  <!-- Message Banner (for color conflict notifications) -->
  <div id="messageBanner" class="hidden border-b border-yellow-300 bg-yellow-50 px-6 py-2">
    <p id="messageText" class="text-sm text-yellow-800"></p>
  </div>

  <!-- Main Content -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Left: Charts -->
    <div class="flex flex-1 flex-col overflow-y-auto p-6">
      <!-- Daily Study Chart -->
      <div class="mb-6">
        <!-- Title and Navigation (spans both graph and stats in weekly view) -->
        <div class="mb-4 flex items-center justify-between rounded-lg border border-gray-300 bg-white p-4">
          <h2 class="text-xl font-semibold" id="dailyChartTitle"> Daily Study Hours</h2>
          <!-- Day Navigation (only visible in weekly view) -->
          <div id="dayNavigation" class="hidden flex items-center gap-2">
            <button id="prevDayBtn" class="rounded-lg border border-gray-300 bg-white px-3 py-1 text-sm hover:bg-gray-50">← Prev Week</button>
            <span id="currentDayLabel" class="px-4 text-sm font-medium cursor-pointer hover:text-blue-600 hover:underline min-w-[200px] text-center" onclick="showDatePicker()">Mon 29 Dec - Sun 4 Jan</span>
            <button id="nextDayBtn" class="rounded-lg border border-gray-300 bg-white px-3 py-1 text-sm hover:bg-gray-50">Next Week →</button>
          </div>
        </div>
        <div class="flex gap-4">
          <div id="dailyChartWrapper" class="rounded-lg border border-gray-300 bg-white p-6">
            <div class="relative" id="dailyChartContainer" style="height: 800px;">
              <canvas id="dailyChart"></canvas>
            </div>
          </div>
          <!-- Week Summary Stats (only visible in weekly view) -->
          <div id="weekSummaryStats" class="hidden flex-1 rounded-lg border border-gray-300 bg-white p-6">
            <h3 class="mb-4 text-lg font-semibold">Week Summary</h3>
            <div id="weekStatsContent" class="space-y-3">
              <!-- Stats will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Subject Comparison Chart -->
      <div class="rounded-lg border border-gray-300 bg-white p-6">
        <h2 class="mb-4 text-xl font-semibold">Subject Comparison</h2>
        <div class="relative h-64">
          <canvas id="subjectChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Right: Legend -->
    <div class="w-64 border-l border-gray-300 bg-white p-6">
      <h3 class="mb-4 text-lg font-semibold">Color Legend</h3>
      <div id="colorLegend" class="space-y-2">
        <!-- Legend items will be populated here -->
      </div>
    </div>
</main>

<!-- Color Organization Modal -->
<div id="colorModal" class="modal bg-opacity-50 fixed inset-0 z-50 flex hidden items-center justify-center overflow-y-auto bg-black py-4">
  <div class="my-auto max-h-[90vh] w-[600px] overflow-y-auto rounded-lg bg-white p-6">
    <h3 class="mb-4 text-xl font-bold">Organize Subject Colors</h3>
    <p class="mb-4 text-sm text-gray-600">Click the color circle to change color, or click the subject name to rename it.</p>
    <div id="colorOrganizationList" class="mb-4 space-y-2">
      <!-- Color organization items will be populated here -->
    </div>
    <button type="button" id="addSubjectBtn" class="mb-4 w-full rounded-lg border border-gray-300 bg-gray-100 px-4 py-2 text-gray-700 hover:bg-gray-200">
      + Add Subject
    </button>
    <div class="flex gap-2">
      <button type="button" onclick="saveColorOrganization()" class="flex-1 rounded-lg border border-black bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">Save</button>
      <button type="button" onclick="closeModal('colorModal')" class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 hover:bg-gray-50">Cancel</button>
    </div>
  </div>
</div>

<!-- Color Picker Modal (for changing colors) -->
<div id="colorPickerModal" class="modal bg-opacity-50 fixed inset-0 z-50 flex hidden items-center justify-center overflow-y-auto bg-black py-4">
  <div class="my-auto max-h-[90vh] w-[400px] overflow-y-auto rounded-lg bg-white p-6">
    <h3 class="mb-4 text-xl font-bold">Choose Color</h3>
    <div id="colorPickerContent" class="mb-4">
      <!-- Color picker will be populated here -->
    </div>
    <div class="flex gap-2">
      <button type="button" onclick="closeModal('colorPickerModal')" class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 hover:bg-gray-50">Cancel</button>
    </div>
  </div>
</div>

<!-- Date Picker Modal -->
<div id="datePickerModal" class="modal bg-opacity-50 fixed inset-0 z-50 flex hidden items-center justify-center overflow-y-auto bg-black py-4">
  <div class="my-auto max-h-[90vh] w-[400px] overflow-y-auto rounded-lg bg-white p-6">
    <h3 class="mb-4 text-xl font-bold">Select Date</h3>
    <div class="mb-4">
      <input type="date" id="datePickerInput" class="w-full rounded border border-gray-300 px-3 py-2" />
    </div>
    <div class="flex gap-2">
      <button type="button" onclick="closeModal('datePickerModal')" class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 hover:bg-gray-50">Cancel</button>
      <button type="button" onclick="applyDatePicker()" class="flex-1 rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">Go</button>
    </div>
  </div>
</div>

<!-- Day Details Modal (for weekly view) -->
<div id="dayDetailsModal" class="modal bg-opacity-50 fixed inset-0 z-50 flex hidden items-center justify-center overflow-y-auto bg-black py-4">
  <div class="my-auto max-h-[90vh] w-[500px] overflow-y-auto rounded-lg bg-white p-6">
    <h3 class="mb-4 text-xl font-bold" id="dayDetailsTitle">Study Sessions</h3>
    <div id="dayDetailsContent" class="space-y-3">
      <!-- Day details will be populated here -->
    </div>
    <div class="mt-4">
      <button type="button" onclick="closeModal('dayDetailsModal')" class="w-full rounded-lg border border-gray-300 bg-white px-4 py-2 hover:bg-gray-50">Close</button>
    </div>
  </div>
</div>

<script src="{% static 'stats.js' %}"></script>
<script>
  // Functions are already exposed in stats.js via window object
  // This is just a safety check
  setTimeout(() => {
    if (typeof window.saveColorOrganization === 'undefined') {
      console.warn('saveColorOrganization not available globally');
    }
    if (typeof window.closeModal === 'undefined') {
      console.warn('closeModal not available globally');
    }
    if (typeof window.showColorOrganizationModal === 'undefined') {
      console.warn('showColorOrganizationModal not available globally');
    }
  }, 100);
</script>
{% endblock %}